name: CI

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3
        with:
          fetch-depth: 0
          lfs: true

      - name: LFS ensure files present
        run: |
          git lfs install
          git lfs fetch --all
          git lfs checkout

      - name: Set up Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e
        with:
          flutter-version: '3.38.1'
          channel: 'stable'
          cache: true

      - name: Verify Flutter installation
        run: flutter doctor -v

      - name: Install dependencies
        run: flutter pub get

      - name: Generate localization files
        run: flutter gen-l10n

      - name: Verify code formatting
        run: |
          # Find Dart files excluding generated and build directories
          # Use -print0 and -0 for safe handling of filenames with spaces
          find . -name "*.dart" \
            -not -path "./lib/l10n/*" \
            -not -path "./build/*" \
            -not -path "./.dart_tool/*" \
            -not -path "./.git/*" \
            -not -path "./android/*" \
            -not -path "./ios/*" \
            -not -path "./web/*" \
            -print0 | xargs -0 -r dart format --set-exit-if-changed

      - name: Analyze code
        run: flutter analyze

      - name: Run tests
        run: flutter test

      - name: Extract version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"

      - name: Set version variables
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION_NAME="${VERSION}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION_NAME"
          : "${MAJOR:=0}" ; : "${MINOR:=0}" ; : "${PATCH:=0}"
          VERSION_CODE=$(printf '%d%02d%02d' "$MAJOR" "$MINOR" "$PATCH")
          echo "VERSION_NAME=$VERSION_NAME" >> "$GITHUB_ENV"
          echo "VERSION_CODE=$VERSION_CODE" >> "$GITHUB_ENV"

      - name: Update app version in pubspec.yaml
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          sed -i "s/^version: .*/version: ${VERSION_NAME}+${VERSION_CODE}/g" pubspec.yaml

      - name: Build APK (tag only)
        if: startsWith(github.ref, 'refs/tags/v')
        run: flutter build apk --target lib/main.dart --release

      - name: Set APK artifact name
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          APK_NAME="jabook-release-${GITHUB_REF_NAME#v}.apk"
          echo "APK_NAME=${APK_NAME}" >> "$GITHUB_ENV"

      - name: Upload APK
        if: startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4
        with:
          name: ${{ env.APK_NAME }}
          path: build/app/outputs/flutter-apk/app-release.apk