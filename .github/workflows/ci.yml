name: CI

on:
  push:
    tags: [ '*' ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          lfs: true

      - name: LFS ensure files present
        run: |
          git lfs install
          git lfs fetch --all
          git lfs checkout

      - name: Set up Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2.21.0
        with:
          flutter-version: '3.38.3'
          channel: 'stable'
          cache: true
          cache-key: 'flutter-sdk-3.38.3-stable-x64'
          pub-cache-key: 'flutter-pub-cache-v1'

      - name: Verify Flutter installation
        run: flutter doctor -v

      - name: Install dependencies
        run: make install

      - name: Check localization files
        run: make check-l10n

      - name: Verify code formatting
        run: make fmt-check

      - name: Analyze code
        run: make analyze

      - name: Check copyright headers
        run: make check-copyright

      - name: Extract version from pubspec.yaml
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version:[[:space:]]*//' | cut -d+ -f1)
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "Extracted version from pubspec.yaml: ${VERSION}"

      - name: Set up JDK 17
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android signing
        env:
          KEYSTORE_BASE64_RAW: ${{ secrets.KEYSTORE_BASE64 }}
          STORE_PASS_RAW: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_PASS_RAW: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS_RAW: ${{ secrets.KEY_ALIAS }}
        run: |
          WORKSPACE_DIR="${{ github.workspace }}"
          KEYSTORE_PATH="${WORKSPACE_DIR}/.signing/release.keystore"
          
          mkdir -p .signing
          echo "${KEYSTORE_BASE64_RAW}" | tr -d '\n\r\t ' | base64 -d > "${KEYSTORE_PATH}"
          
          if [ ! -f "${KEYSTORE_PATH}" ]; then
            echo "ERROR: Keystore file was not created"
            exit 1
          fi
          
          KEYSTORE_SIZE=$(stat -f%z "${KEYSTORE_PATH}" 2>/dev/null || stat -c%s "${KEYSTORE_PATH}" 2>/dev/null)
          if [ "$KEYSTORE_SIZE" -lt 1000 ]; then
            echo "ERROR: Keystore file too small (${KEYSTORE_SIZE} bytes)"
            exit 1
          fi
          
          STORE_PASS=$(printf '%s' "${STORE_PASS_RAW}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr -d '\n\r')
          KEY_PASS=$(printf '%s' "${KEY_PASS_RAW}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr -d '\n\r')
          KEY_ALIAS=$(printf '%s' "${KEY_ALIAS_RAW}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr -d '\n\r')
          
          mkdir -p android
          {
            echo "storeFile=${KEYSTORE_PATH}"
            printf 'storePassword=%s\n' "${STORE_PASS}"
            printf 'keyPassword=%s\n' "${KEY_PASS}"
            printf 'keyAlias=%s\n' "${KEY_ALIAS}"
          } > android/key.properties

      - name: Build beta APK
        env:
          GRADLE_OPTS: "-Xmx4g -XX:MaxMetaspaceSize=1g -XX:ReservedCodeCacheSize=1g"
        run: make build-android-beta-ci

      - name: Verify APK files exist
        id: verify-apk
        run: |
          UNIVERSAL_APK=""
          SPLIT_APKS=""
          
          if [ -f "build/app/outputs/flutter-apk/app-beta-release.apk" ]; then
            UNIVERSAL_APK="build/app/outputs/flutter-apk/app-beta-release.apk"
          elif [ -f "build/app/outputs/apk/release/app-beta-release.apk" ]; then
            UNIVERSAL_APK="build/app/outputs/apk/release/app-beta-release.apk"
          fi
          
          for arch in arm64-v8a armeabi-v7a x86_64; do
            if [ -f "build/app/outputs/flutter-apk/app-${arch}-beta-release.apk" ]; then
              SPLIT_APKS="${SPLIT_APKS}build/app/outputs/flutter-apk/app-${arch}-beta-release.apk"$'\n'
            elif [ -f "build/app/outputs/apk/release/app-${arch}-beta-release.apk" ]; then
              SPLIT_APKS="${SPLIT_APKS}build/app/outputs/apk/release/app-${arch}-beta-release.apk"$'\n'
            fi
          done
          
          SPLIT_APKS=$(echo "$SPLIT_APKS" | sed '/^$/d')
          
          ALL_APKS=""
          if [ -n "$UNIVERSAL_APK" ]; then
            ALL_APKS="${UNIVERSAL_APK}"$'\n'
          fi
          if [ -n "$SPLIT_APKS" ]; then
            ALL_APKS="${ALL_APKS}${SPLIT_APKS}"
          fi
          
          ALL_APKS=$(echo "$ALL_APKS" | sed '/^$/d')
          
          if [ -z "$ALL_APKS" ]; then
            echo "‚ö†Ô∏è  Warning: No APK files found!"
            echo "has_files=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Found APK files:"
            echo "$ALL_APKS"
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$ALL_APKS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Rename APK files
        if: steps.verify-apk.outputs.has_files == 'true'
        id: rename-apk
        run: |
          mkdir -p release-apks
          RENAMED_APKS=""
          
          # Rename universal APK
          if [ -f "build/app/outputs/flutter-apk/app-beta-release.apk" ]; then
            cp "build/app/outputs/flutter-apk/app-beta-release.apk" "release-apks/Jabook_${VERSION}_beta_universal.apk"
            RENAMED_APKS="${RENAMED_APKS}release-apks/Jabook_${VERSION}_beta_universal.apk"$'\n'
          elif [ -f "build/app/outputs/apk/release/app-beta-release.apk" ]; then
            cp "build/app/outputs/apk/release/app-beta-release.apk" "release-apks/Jabook_${VERSION}_beta_universal.apk"
            RENAMED_APKS="${RENAMED_APKS}release-apks/Jabook_${VERSION}_beta_universal.apk"$'\n'
          fi
          
          # Rename architecture-specific APKs
          if [ -f "build/app/outputs/flutter-apk/app-armeabi-v7a-beta-release.apk" ]; then
            cp "build/app/outputs/flutter-apk/app-armeabi-v7a-beta-release.apk" "release-apks/Jabook_${VERSION}_beta_v7a.apk"
            RENAMED_APKS="${RENAMED_APKS}release-apks/Jabook_${VERSION}_beta_v7a.apk"$'\n'
          elif [ -f "build/app/outputs/apk/release/app-armeabi-v7a-beta-release.apk" ]; then
            cp "build/app/outputs/apk/release/app-armeabi-v7a-beta-release.apk" "release-apks/Jabook_${VERSION}_beta_v7a.apk"
            RENAMED_APKS="${RENAMED_APKS}release-apks/Jabook_${VERSION}_beta_v7a.apk"$'\n'
          fi
          
          if [ -f "build/app/outputs/flutter-apk/app-arm64-v8a-beta-release.apk" ]; then
            cp "build/app/outputs/flutter-apk/app-arm64-v8a-beta-release.apk" "release-apks/Jabook_${VERSION}_beta_v8a.apk"
            RENAMED_APKS="${RENAMED_APKS}release-apks/Jabook_${VERSION}_beta_v8a.apk"$'\n'
          elif [ -f "build/app/outputs/apk/release/app-arm64-v8a-beta-release.apk" ]; then
            cp "build/app/outputs/apk/release/app-arm64-v8a-beta-release.apk" "release-apks/Jabook_${VERSION}_beta_v8a.apk"
            RENAMED_APKS="${RENAMED_APKS}release-apks/Jabook_${VERSION}_beta_v8a.apk"$'\n'
          fi
          
          if [ -f "build/app/outputs/flutter-apk/app-x86_64-beta-release.apk" ]; then
            cp "build/app/outputs/flutter-apk/app-x86_64-beta-release.apk" "release-apks/Jabook_${VERSION}_beta_x86_64.apk"
            RENAMED_APKS="${RENAMED_APKS}release-apks/Jabook_${VERSION}_beta_x86_64.apk"$'\n'
          elif [ -f "build/app/outputs/apk/release/app-x86_64-beta-release.apk" ]; then
            cp "build/app/outputs/apk/release/app-x86_64-beta-release.apk" "release-apks/Jabook_${VERSION}_beta_x86_64.apk"
            RENAMED_APKS="${RENAMED_APKS}release-apks/Jabook_${VERSION}_beta_x86_64.apk"$'\n'
          fi
          
          RENAMED_APKS=$(echo "$RENAMED_APKS" | sed '/^$/d')
          
          if [ -z "$RENAMED_APKS" ]; then
            echo "‚ö†Ô∏è  Warning: No APK files to rename!"
            echo "has_files=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Renamed APK files:"
            echo "$RENAMED_APKS"
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$RENAMED_APKS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        if: steps.verify-apk.outputs.has_files == 'true'
        run: make changelog

      - name: Create GitHub Prerelease
        if: steps.rename-apk.outputs.has_files == 'true'
        id: release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ env.VERSION }}-beta
          body_path: CHANGELOG.md
          draft: false
          prerelease: true
          files: ${{ steps.rename-apk.outputs.files }}
          fail_on_unmatched_files: false
          generate_release_notes: false
          make_latest: false

      - name: Send Telegram notification
        if: steps.release.outcome == 'success'
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.JABOOK_CHAT_ID }}
          token: ${{ secrets.TG_RELEASER_TOKEN }}
          format: html
          message: |
            üöÄ <b>–ù–æ–≤—ã–π beta-—Ä–µ–ª–∏–∑ Jabook</b>

            <b>–í–µ—Ä—Å–∏—è:</b> <code>${{ env.VERSION }}-beta</code>
            <b>–¢–µ–≥:</b> <code>${{ github.ref_name }}</code>
            <b>–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:</b> <code>${{ github.repository }}</code>
            <b>–ê–≤—Ç–æ—Ä:</b> <code>${{ github.actor }}</code>

            üì¶ <a href="https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}">–°–∫–∞—á–∞—Ç—å —Ä–µ–ª–∏–∑</a>

            ‚úÖ –†–µ–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!