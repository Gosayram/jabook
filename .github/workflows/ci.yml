name: CI

on:
  push:
    tags: ['*']

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Extract version from .release-version
        run: |
          FULL_VERSION=$(cat .release-version)
          VERSION=$(echo "$FULL_VERSION" | cut -d+ -f1)
          BUILD=$(echo "$FULL_VERSION" | cut -d+ -f2)
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "BUILD=${BUILD}" >> "$GITHUB_ENV"
          echo "FULL_VERSION=${FULL_VERSION}" >> "$GITHUB_ENV"
          echo "Extracted version: ${VERSION}, build: ${BUILD}"

      - name: Set up JDK 21
        uses: actions/setup-java@f2beeb24e141e01a676f977032f5a29d81c9e27e # v5.1.0
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Setup Android SDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: Setup Android signing
        env:
          KEYSTORE_BASE64_RAW: ${{ secrets.KEYSTORE_BASE64 }}
          STORE_PASS_RAW: ${{ secrets.KEY_STORE_PASSWORD }}
          KEY_PASS_RAW: ${{ secrets.KEY_PASSWORD }}
          KEY_ALIAS_RAW: ${{ secrets.KEY_ALIAS }}
        run: |
          WORKSPACE_DIR="${{ github.workspace }}"
          KEYSTORE_PATH="${WORKSPACE_DIR}/.signing/release.keystore"
          
          mkdir -p .signing
          echo "${KEYSTORE_BASE64_RAW}" | tr -d '\n\r\t ' | base64 -d > "${KEYSTORE_PATH}"
          
          if [ ! -f "${KEYSTORE_PATH}" ]; then
            echo "ERROR: Keystore file was not created"
            exit 1
          fi
          
          KEYSTORE_SIZE=$(stat -c%s "${KEYSTORE_PATH}" 2>/dev/null)
          if [ "$KEYSTORE_SIZE" -lt 1000 ]; then
            echo "ERROR: Keystore file too small (${KEYSTORE_SIZE} bytes)"
            exit 1
          fi
          
          STORE_PASS=$(printf '%s' "${STORE_PASS_RAW}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr -d '\n\r')
          KEY_PASS=$(printf '%s' "${KEY_PASS_RAW}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr -d '\n\r')
          KEY_ALIAS=$(printf '%s' "${KEY_ALIAS_RAW}" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | tr -d '\n\r')
          
          mkdir -p android
          {
            echo "storeFile=${KEYSTORE_PATH}"
            printf 'storePassword=%s\n' "${STORE_PASS}"
            printf 'keyPassword=%s\n' "${KEY_PASS}"
            printf 'keyAlias=%s\n' "${KEY_ALIAS}"
          } > android/key.properties

      - name: Lint Kotlin code
        run: make lint-kotlin

      - name: Build beta APK
        env:
          GRADLE_OPTS: "-Xmx4g -XX:MaxMetaspaceSize=1g -XX:ReservedCodeCacheSize=1g"
        run: make build-beta

      - name: Verify and rename APK files
        id: rename-apk
        run: |
          mkdir -p release-apks
          RENAMED_APKS=""
          
          # Check for universal APK
          if [ -f "android/app/build/outputs/apk/beta/release/app-beta-release.apk" ]; then
            cp "android/app/build/outputs/apk/beta/release/app-beta-release.apk" "release-apks/Jabook_${VERSION}_beta_universal.apk"
            RENAMED_APKS="${RENAMED_APKS}release-apks/Jabook_${VERSION}_beta_universal.apk"$'\n'
          fi
          
          # Check for architecture-specific APKs
          for arch in arm64-v8a armeabi-v7a x86_64; do
            APK_PATH="android/app/build/outputs/apk/beta/release/app-beta-${arch}-release.apk"
            if [ -f "$APK_PATH" ]; then
              ARCH_SUFFIX="${arch}"
              if [ "$arch" = "arm64-v8a" ]; then
                ARCH_SUFFIX="v8a"
              elif [ "$arch" = "armeabi-v7a" ]; then
                ARCH_SUFFIX="v7a"
              fi
              cp "$APK_PATH" "release-apks/Jabook_${VERSION}_beta_${ARCH_SUFFIX}.apk"
              RENAMED_APKS="${RENAMED_APKS}release-apks/Jabook_${VERSION}_beta_${ARCH_SUFFIX}.apk"$'\n'
            fi
          done
          
          RENAMED_APKS=$(echo "$RENAMED_APKS" | sed '/^$/d')
          
          if [ -z "$RENAMED_APKS" ]; then
            echo "‚ö†Ô∏è  Warning: No APK files found!"
            echo "has_files=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Renamed APK files:"
            echo "$RENAMED_APKS"
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$RENAMED_APKS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        if: steps.rename-apk.outputs.has_files == 'true'
        run: |
          # Simple changelog from recent commits
          echo "# Changelog for ${FULL_VERSION}" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          git log --pretty=format:"- %s (%h)" --since="1 week ago" >> CHANGELOG.md

      - name: Create GitHub Prerelease
        if: steps.rename-apk.outputs.has_files == 'true'
        id: release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ env.VERSION }}-beta (build ${{ env.BUILD }})
          body_path: CHANGELOG.md
          draft: false
          prerelease: true
          files: ${{ steps.rename-apk.outputs.files }}
          fail_on_unmatched_files: false
          generate_release_notes: false
          make_latest: false

      - name: Send Telegram notification
        if: steps.release.outcome == 'success'
        uses: appleboy/telegram-action@221e6b684967abe813051ee4a37dd61770a83ad3 # v1.0.1
        with:
          to: ${{ secrets.JABOOK_CHAT_ID }}
          token: ${{ secrets.TG_RELEASER_TOKEN }}
          format: html
          message: |
            üöÄ <b>–ù–æ–≤—ã–π beta-—Ä–µ–ª–∏–∑ Jabook (Kotlin)</b>

            <b>–í–µ—Ä—Å–∏—è:</b> <code>${{ env.VERSION }}-beta</code>
            <b>Build:</b> <code>${{ env.BUILD }}</code>
            <b>–¢–µ–≥:</b> <code>${{ github.ref_name }}</code>
            <b>–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:</b> <code>${{ github.repository }}</code>
            <b>–ê–≤—Ç–æ—Ä:</b> <code>${{ github.actor }}</code>

            üì¶ <a href="https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}">–°–∫–∞—á–∞—Ç—å —Ä–µ–ª–∏–∑</a>

            ‚úÖ –†–µ–ª–∏–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!