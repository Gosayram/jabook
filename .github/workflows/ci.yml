name: CI

on:
  push:
    tags: [ '*' ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout (with LFS)
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0
          lfs: true

      - name: LFS ensure files present
        run: |
          git lfs install
          git lfs fetch --all
          git lfs checkout

      - name: Set up Flutter
        uses: subosito/flutter-action@fd55f4c5af5b953cc57a2be44cb082c8f6635e8e # v2.21.0
        with:
          flutter-version: '3.38.3'
          channel: 'stable'
          cache: true
          cache-key: 'flutter-sdk-3.38.3-stable-x64'
          pub-cache-key: 'flutter-pub-cache-v1'

      - name: Verify Flutter installation
        run: flutter doctor -v

      - name: Install dependencies
        run: make install

      - name: Check localization files
        run: make check-l10n

      - name: Verify code formatting
        run: make fmt-check

      - name: Analyze code
        run: make analyze

      - name: Check copyright headers
        run: make check-copyright

      - name: Extract version from pubspec.yaml
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version:[[:space:]]*//' | cut -d+ -f1)
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"
          echo "Extracted version from pubspec.yaml: ${VERSION}"

      - name: Set up JDK 17
        uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android signing
        run: |
          # Get absolute path to workspace
          WORKSPACE_DIR="${{ github.workspace }}"
          KEYSTORE_PATH="${WORKSPACE_DIR}/.signing/release.keystore"
          
          # Create .signing directory
          mkdir -p .signing
          
          # Decode keystore from base64 secret (remove any whitespace/newlines)
          echo "${{ secrets.KEYSTORE_BASE64 }}" | tr -d '\n\r\t ' | base64 -d > "${KEYSTORE_PATH}"
          
          # Verify keystore file was created
          if [ ! -f "${KEYSTORE_PATH}" ]; then
            echo "ERROR: Keystore file was not created at ${KEYSTORE_PATH}"
            exit 1
          fi
          
          # Verify keystore file size
          KEYSTORE_SIZE=$(stat -f%z "${KEYSTORE_PATH}" 2>/dev/null || stat -c%s "${KEYSTORE_PATH}" 2>/dev/null)
          if [ "$KEYSTORE_SIZE" -lt 1000 ]; then
            echo "ERROR: Keystore file seems too small (${KEYSTORE_SIZE} bytes)"
            exit 1
          fi
          
          # Verify secrets are not empty (without showing values)
          if [ -z "${{ secrets.KEY_STORE_PASSWORD }}" ]; then
            echo "ERROR: KEY_STORE_PASSWORD secret is empty"
            exit 1
          fi
          if [ -z "${{ secrets.KEY_PASSWORD }}" ]; then
            echo "ERROR: KEY_PASSWORD secret is empty"
            exit 1
          fi
          if [ -z "${{ secrets.KEY_ALIAS }}" ]; then
            echo "ERROR: KEY_ALIAS secret is empty"
            exit 1
          fi
          
          # Create android/key.properties file with absolute path
          mkdir -p android
          cat > android/key.properties <<EOF
          storeFile=${KEYSTORE_PATH}
          storePassword=${{ secrets.KEY_STORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          EOF
          
          # Verify key.properties was created
          if [ ! -f android/key.properties ]; then
            echo "ERROR: key.properties file was not created"
            exit 1
          fi
          
          echo "Android signing configured"
          echo "Keystore file size: ${KEYSTORE_SIZE} bytes"
          echo "key.properties created successfully"
          
          # Optional: Test keystore access (verify password is correct)
          # This is optional because Gradle will verify during build
          echo "Testing keystore access (optional verification)..."
          
          # Verify keytool is available
          if ! command -v keytool &> /dev/null; then
            echo "⚠️  WARNING: keytool is not available, skipping keystore verification"
            echo "Gradle will verify keystore during build"
          else
            echo "Keytool version:"
            keytool -help 2>&1 | head -1 || true
            
            # Try to detect keystore type and test access
            # First try JKS (default, most common for older keystores)
            echo "Step 1: Testing keystore with default storetype (JKS)..."
            KEYTOOL_OUTPUT=$(keytool -list \
              -keystore "${KEYSTORE_PATH}" \
              -storepass "${{ secrets.KEY_STORE_PASSWORD }}" \
              2>&1)
            KEYTOOL_EXIT_CODE=$?
            
            # If JKS fails, try PKCS12
            if [ $KEYTOOL_EXIT_CODE -ne 0 ]; then
              echo "JKS failed, trying PKCS12 storetype..."
              KEYTOOL_OUTPUT=$(keytool -list \
                -keystore "${KEYSTORE_PATH}" \
                -storetype PKCS12 \
                -storepass "${{ secrets.KEY_STORE_PASSWORD }}" \
                2>&1)
              KEYTOOL_EXIT_CODE=$?
            fi
            
            if [ $KEYTOOL_EXIT_CODE -eq 0 ]; then
              echo "✅ Keystore password is correct"
              echo "Available aliases in keystore:"
              echo "$KEYTOOL_OUTPUT" | grep -E '^[a-zA-Z0-9_-]+,' || echo "$KEYTOOL_OUTPUT" | grep -i alias || echo "Could not parse aliases"
              
              # Step 2: Test specific alias and key password
              echo "Step 2: Testing alias '${{ secrets.KEY_ALIAS }}' and key password..."
              KEYTOOL_ALIAS_OUTPUT=$(keytool -list -v \
                -keystore "${KEYSTORE_PATH}" \
                -storepass "${{ secrets.KEY_STORE_PASSWORD }}" \
                -alias "${{ secrets.KEY_ALIAS }}" \
                -keypass "${{ secrets.KEY_PASSWORD }}" \
                2>&1)
              KEYTOOL_ALIAS_EXIT_CODE=$?
              
              # If default fails, try PKCS12
              if [ $KEYTOOL_ALIAS_EXIT_CODE -ne 0 ]; then
                KEYTOOL_ALIAS_OUTPUT=$(keytool -list -v \
                  -keystore "${KEYSTORE_PATH}" \
                  -storetype PKCS12 \
                  -storepass "${{ secrets.KEY_STORE_PASSWORD }}" \
                  -alias "${{ secrets.KEY_ALIAS }}" \
                  -keypass "${{ secrets.KEY_PASSWORD }}" \
                  2>&1)
                KEYTOOL_ALIAS_EXIT_CODE=$?
              fi
              
              if [ $KEYTOOL_ALIAS_EXIT_CODE -eq 0 ]; then
                echo "✅ Alias and key password are correct"
              else
                echo "⚠️  WARNING: Alias or key password test failed"
                echo "This might be okay - Gradle will verify during build"
                echo "Keytool error (passwords hidden):"
                echo "$KEYTOOL_ALIAS_OUTPUT" | sed 's/storepass [^ ]*/storepass ***/g' | sed 's/keypass [^ ]*/keypass ***/g' | head -5
              fi
            else
              echo "⚠️  WARNING: Keystore password test failed"
              echo "This might be okay - Gradle will verify during build"
              echo "Keytool error output (password hidden):"
              echo "$KEYTOOL_OUTPUT" | sed 's/storepass [^ ]*/storepass ***/g' | sed 's/keypass [^ ]*/keypass ***/g' | head -10
              echo ""
              echo "Note: If keystore is corrupted or password is wrong, Gradle build will fail with a clear error message"
            fi
          fi
          
          echo "✅ Keystore setup completed (Gradle will verify during build)"

      - name: Build beta APK
        env:
          # Increase Gradle memory for CI builds
          GRADLE_OPTS: "-Xmx4g -XX:MaxMetaspaceSize=1g -XX:ReservedCodeCacheSize=1g"
        run: make build-android-beta-ci

      - name: Verify APK files exist
        id: verify-apk
        run: |
          # Check for APK files in both possible locations
          UNIVERSAL_APK=""
          SPLIT_APKS=""
          
          # Universal APK
          if [ -f "build/app/outputs/flutter-apk/app-beta-release.apk" ]; then
            UNIVERSAL_APK="build/app/outputs/flutter-apk/app-beta-release.apk"
          elif [ -f "build/app/outputs/apk/release/app-beta-release.apk" ]; then
            UNIVERSAL_APK="build/app/outputs/apk/release/app-beta-release.apk"
          fi
          
          # Split APKs
          for arch in arm64-v8a armeabi-v7a x86_64; do
            if [ -f "build/app/outputs/flutter-apk/app-${arch}-beta-release.apk" ]; then
              SPLIT_APKS="${SPLIT_APKS}build/app/outputs/flutter-apk/app-${arch}-beta-release.apk"$'\n'
            elif [ -f "build/app/outputs/apk/release/app-${arch}-beta-release.apk" ]; then
              SPLIT_APKS="${SPLIT_APKS}build/app/outputs/apk/release/app-${arch}-beta-release.apk"$'\n'
            fi
          done
          
          # Remove trailing newline
          SPLIT_APKS=$(echo "$SPLIT_APKS" | sed '/^$/d')
          
          # Combine all APKs
          ALL_APKS=""
          if [ -n "$UNIVERSAL_APK" ]; then
            ALL_APKS="${UNIVERSAL_APK}"$'\n'
          fi
          if [ -n "$SPLIT_APKS" ]; then
            ALL_APKS="${ALL_APKS}${SPLIT_APKS}"
          fi
          
          # Remove trailing newline
          ALL_APKS=$(echo "$ALL_APKS" | sed '/^$/d')
          
          if [ -z "$ALL_APKS" ]; then
            echo "⚠️  Warning: No APK files found!"
            echo "has_files=false" >> $GITHUB_OUTPUT
          else
            echo "✅ Found APK files:"
            echo "$ALL_APKS"
            echo "has_files=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$ALL_APKS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        if: steps.verify-apk.outputs.has_files == 'true'
        run: make changelog

      - name: Create GitHub Prerelease
        if: steps.verify-apk.outputs.has_files == 'true'
        id: release
        uses: softprops/action-gh-release@5be0e66d93ac7ed76da52eca8bb058f665c3a5fe # v2.4.2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ env.VERSION }}-beta
          body_path: CHANGELOG.md
          draft: false
          prerelease: true
          files: ${{ steps.verify-apk.outputs.files }}
          fail_on_unmatched_files: false
          generate_release_notes: false
          make_latest: false